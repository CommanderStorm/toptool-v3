{% extends "base.html" %}
{% load i18n %}
{% load l10n %}
{% load django_bootstrap5 %}

{% block title %}{{ meetingtype }} - {% if search %}{% trans "Suche" %}{% else %}{% trans "Sitzungsübersicht" %}
{% endif %}{% endblock %}

{% block content %}
<h1>{{ meetingtype.name }}: {% if search %}{% trans "Suche" %}{% else %}{% trans "Alle Sitzungen" %}{% endif %}</h1>

<div class="row">
    {% if ical_url %}
    <div class="col-md-4 col-xl-3">
        <div class="card panel-custom">
            <div class="card-body panel-center">
                <a
                    class="collapse-toggle"
                    data-bs-toggle="collapse"
                    data-bs-target="#ical-body"
                ><span class="bi bi-calendar3"></span> {% trans "ical-Kalender abonnieren" %}</a>
                <div
                    class="collapse in"
                    id="ical-body"
                    style="margin-top:10px;"
                >
                    <label
                        class="form-label"
                        for="icalURL"
                    >
                        {% trans 'Kopiere dir diese URL und füge sie in deinem Kalenderprogramm unter "Kalender abonnieren" ein.' %}
                    </label>
                    <input
                        id="icalURL"
                        value="{{ ical_url }}"
                        style="width:100%;"
                        readonly
                    >
                    <a
                        class="asbtn"
                        onclick="copyText()"
                        style="cursor: pointer;"
                    ><span class="bi bi-clipboard"></span> {% trans "URL kopieren" %}</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% if meetingtype.admin_permission in perms %}
    <div class="col-md-8 col-xl-6">
        <div class="card panel-custom">
            <div class="card-body panel-center">
                <a
                    href="{% url "meetingtypes:edit_meetingtype" meetingtype.id %}"
                    class="asbtn-left"
                ><span class="bi bi-gear"></span> {% trans "Sitzungsgruppe bearbeiten" %}</a>
                <a
                    href="{% url "meetings:add_meeting" meetingtype.id %}"
                    class="asbtn"
                ><span class="bi bi-plus"></span> {% trans "Sitzung anlegen" %}</a>
                <a
                    href="{% url "meetings:add_meetings_series" meetingtype.id %}"
                    class="asbtn-right"
                ><span class="bi bi-plus"></span> <span class="bi bi-list"></span> {% trans "Sitzungsserie anlegen" %}</a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<form
    method="post"
    action="{% url "meetingtypes:search_meetingtype" meetingtype.id %}"
>
    {% csrf_token %}
    <input
        type="search"
        name="query"
        value="{{ search_query }}"
        maxlength="200"
        class="form-control"
        placeholder="{% trans "Suchbegriff eingeben..." %}"
        title=""
        id="query"
    >
</form>

<h2 class="mt-4">{% trans "Kommende Sitzungen" %}</h2>
{% if upcoming_meetings %}
<table class="table table-striped table-hover table-responsive">
    <thead>
        <tr>
            <th>{% trans "Sitzung" %}</th>
            <th>{% trans "Datum" %}</th>
            <th>{% trans "Zeit" %}</th>
            <th>{% trans "Raum" %}</th>
            {% if meetingtype.tops %}<th>{% trans "TOPs" %}</th>{% endif %}
            <th>{% trans "Bearbeiten" %}</th>
            {% if search %}<th>{% trans "Fundort" %}</th>{% endif %}
        </tr>
    </thead>
    <tbody>
        {% for meeting, location in upcoming_meetings.items %}
        <tr>
            <td>
                <a href="{% url "meetings:view_meeting" meeting.id %}">
                    {{ meeting.get_title }}
                    {% if user == meeting.sitzungsleitung %}<span class="bi bi-person-fill"></span>{% endif %}
                    {% if meetingtype.protokoll and user in meeting.minute_takers.all %}<span class="bi bi-pencil-square"></span>{% endif %}
                </a>
            </td>
            <td>{{ meeting.time|date:"D" }} {{ meeting.time|date:"SHORT_DATE_FORMAT" }}</td>
            <td>{{ meeting.time|date:"TIME_FORMAT" }}</td>
            <td>{{ meeting.room | urlize }}</td>
            {% if meeting.meetingtype.tops %}
            <td>
                {% if not meeting.imported %}
                {% if meeting.meetingtype.top_perms == "public" %}
                {% if not meeting.topdeadline_over or meeting.meetingtype.admin_permission in perms or user == meeting.sitzungsleitung %}
                <a
                    href="{% url "tops:add_top" meeting.id %}"
                    class="asbtn"
                ><span class="bi bi-plus"></span> {% trans "TOP eintragen" %}</a>
                {% endif %}
                {% elif meeting.meetingtype.top_perms == "perm" and meeting.meetingtype.permission in perms %}
                {% if not meeting.topdeadline_over or meeting.meetingtype.admin_permission in perms or user == meeting.sitzungsleitung %}
                <a
                    href="{% url "tops:add_top" meeting.id %}"
                    class="asbtn"
                ><span class="bi bi-plus"></span> {% trans "TOP eintragen" %}</a>
                {% endif %}
                {% elif meeting.meetingtype.top_perms == "admin" %}
                {% if meeting.meetingtype.admin_permission in perms or user == meeting.sitzungsleitung %}
                <a
                    href="{% url "tops:add_top" meeting.id %}"
                    class="asbtn"
                ><span class="bi bi-plus"></span> {% trans "TOP eintragen" %}</a>
                {% endif %}
                {% endif %}
                {% endif %}
            </td>
            {% endif %}
            <td>
                {% if meetingtype.admin_permission in perms or user == meeting.sitzungsleitung %}
                <a
                    href="{% url "meetings:edit_meeting" meeting.id %}"
                    class="asbtn"
                ><span class="bi bi-pencil-square"></span> {% trans "bearbeiten" %}</a>
                {% endif %}
                {% if meetingtype.admin_permission in perms %}
                <a
                    href="{% url "meetings:del_meeting" meeting.id %}"
                    class="asbtn"
                ><span class="bi bi-trash"></span> {% trans "löschen" %}</a>
                {% endif %}
            </td>
            {% if search %}
            <td>
                {% for loc in location %}
                {% trans loc %}{% if not forloop.last %},{% endif %}
                {% endfor %}
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p>{% if search %}{% trans "Keine Treffer in kommenden Sitzungen." %}{% else %}
    {% trans "Derzeit ist keine Sitzung eingetragen." %}{% endif %}</p>
{% endif %}

<h2>{% trans "Vergangene Sitzungen" %}</h2>
{% if past_meetings %}
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>{% trans "Sitzung" %}</th>
                <th>{% trans "Datum" %}</th>
                <th>{% trans "Zeit" %}</th>
                <th>{% trans "Raum" %}</th>
                {% if meetingtype.protokoll %}<th>{% trans "Protokoll" %}</th>{% endif %}
                <th>{% trans "Bearbeiten" %}</th>
                {% if search %}<th>{% trans "Fundort" %}</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for meeting, location in past_meetings.items %}
            <tr>
                <td><a href="{% url "meetings:view_meeting" meeting.id %}">
                        {{ meeting.get_title }}{% if user == meeting.sitzungsleitung %}
                        <span class="bi bi-person-fill"></span>{% endif %}
                        {% if meetingtype.protokoll and user in meeting.minute_takers.all %}
                        <span class="bi bi-pencil-square"></span>{% endif %}</a></td>
                <td>{{ meeting.time|date:"D" }} {{ meeting.time|date:"SHORT_DATE_FORMAT" }}</td>
                <td>{{ meeting.time|date:"TIME_FORMAT" }}</td>
                <td>{{ meeting.room | urlize }}</td>
                {% if meetingtype.protokoll %}
                <td>
                    {% if meeting.protokoll and meeting.protokoll.published %}
                    {% if meetingtype.permission in perms or meeting.protokoll.approved %}
                    <a
                        href="{% url "protokolle:show_protokoll" meeting.id "html" %}"
                        class="asbtn-left"
                    >
                        {% if meeting.protokoll.approved %}<span class="bi bi-file-arrow-down"></span>{% else %}<span class="bi bi-cloud-check"></span>{% endif %} HTML</a>
                    <a
                        href="{% url "protokolle:show_protokoll" meeting.id "pdf" %}"
                        class="asbtn"
                    >
                        {% if meeting.protokoll.approved %}<span class="bi bi-file-arrow-down"></span>{% else %}<span class="bi bi-cloud-check"></span>{% endif %} PDF</a>
                    <a
                        href="{% url "protokolle:show_protokoll" meeting.id "txt" %}"
                        class="asbtn-right"
                    >
                        {% if meeting.protokoll.approved %}<span class="bi bi-file-arrow-down"></span>{% else %}<span class="bi bi-cloud-check"></span>{% endif %} TXT</a>
                    {% endif %}
                    {% endif %}
                </td>
                {% endif %}
                <td>
                    {% if meetingtype.admin_permission in perms or user == meeting.sitzungsleitung %}
                    <a
                        href="{% url "meetings:edit_meeting" meeting.id %}"
                        class="asbtn"
                    ><span class="bi bi-pencil-square"></span> {% trans "bearbeiten" %}</a>
                    {% endif %}
                    {% if meetingtype.admin_permission in perms %}
                    <a
                        href="{% url "meetings:del_meeting" meeting.id %}"
                        class="asbtn"
                    ><span class="bi bi-trash"></span> {% trans "löschen" %}</a>
                    {% endif %}
                </td>
                {% if search %}
                <td>{% for loc in location %}{% trans loc %}{% if not forloop.last %},
                    {% endif %}{% endfor %}</td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>{% if search %}{% trans "Keine Treffer in vergangenen Sitzungen." %}{% else %}
    {% trans "In diesem Jahr hat noch keine Sitzung stattgefunden." %}{% endif %}</p>
{% endif %}

<h2>{% trans "Archiv" %}</h2>
<nav aria-label="Archive">
    <ul class="pagination">
        <li class="{% if not prev %}disabled {% endif %}page-item">
            <a
                class="page-link"
                {% if prev %}
                {% if search %}href="javascript:"
                onclick="document.getElementById('form_archive_{{ prev }}').submit();"
                {% else %}href="{% url "meetingtypes:view_archive" meetingtype.id prev %}"
                {% endif %}
                {% endif %}
                aria-label="Previous"
            >
                <span class="bi bi-chevron-left"></span>
            </a>
        </li>
        {% for year in years %}
        <li class="{% if forloop.last %}active {% endif %}page-item">
            <a
                class="page-link"
                {% if not forloop.last %}
                {% if search %}href="javascript:"
                onclick="document.getElementById('form_archive_{{ year|unlocalize }}').submit();"
                {% else %}href="{% url "meetingtypes:view_archive" meetingtype.id year %}"
                {% endif %}
                {% endif %}
            >{{ year|unlocalize }}</a>
        </li>
        {% endfor %}
        <li class="disabled page-item">
            <a
                class="page-link"
                aria-label="Next"
            >
                <span class="bi bi-chevron-right"></span>
            </a>
        </li>
    </ul>
</nav>
{% if search %}
{% for year in years %}
{% if not forloop.last %}
<form
    id="form_archive_{{ year|unlocalize }}"
    action="{% url "meetingtypes:search_archive" meetingtype.id year %}"
    method="POST"
>{% csrf_token %}<input
        type="hidden"
        name="query"
        value="{{ search_query }}"
    >
</form>
{% endif %}
{% endfor %}
{% endif %}
{% if ical_url %}
<script>
    $("#ical-body").collapse();

    function copyText() {
        const input = document.getElementById("icalURL");
        input.select();
        document.execCommand("Copy");
        input.selectionEnd = input.selectionStart;
    }
</script>
{% endif %}
{% endblock %}
